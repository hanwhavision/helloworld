name: MOPL_AWS_DinD_Build
run-name: ${{ github.actor }} is building out GitHub Actions üöÄ
on:
  workflow_dispatch:
    inputs:
      SERVICE_NAME:
        description: 'ÎπåÎìúÌï† ÏÑúÎπÑÏä§Î•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.'
        required: true
        default: 'admin-frontend'
        type: choice
        options:
        - admin-frontend
        - apartment-service
        - vote-service
        - audit-service
        - authn-service
        - device-service
        - forum-service
        - reservation-service
        - verification-service
        - user-service

      ENVPREFIX:
        required: true
        default: 'prod'
        type: choice
        options:
        - prod
        - QA        

      DOCKER_PUSH:
        description: 'ÎπåÎìúÎêú Docker Ïù¥ÎØ∏ÏßÄÎ•º awsÏóê PushÌïòÍ≥† TAGÏ†ïÎ≥¥Î•º ÏóÖÎç∞Ïù¥Ìä∏ Ìï† ÏßÄ ÏÑ†ÌÉùÌï©ÎãàÎã§.'
        type: boolean
        required: true
        default: false
  
jobs:
  Build-GitHub-Actions:
    runs-on: ubuntu-latest
    container:
        image: ghcr.io/backend-sw-development-team4/aws_ecr:1.0.2
        options: --user root
        credentials:
           username: hyunsu.kang
           password: ${{  secrets.PACKAGE_CONTAINER_AUTH }}
    steps:
      - run: |
          echo "üéâ The job was automatically triggered by a ${{ github.event_name }} event."
          echo "SERVICE_NAME: $SERVICE_NAME"
          echo "ENVPREFIX: $ENVPREFIX"
          echo "DOCKER_PUSH: $DOCKER_PUSH"
        env:
          SERVICE_NAME: ${{ inputs.SERVICE_NAME }}
          ENVPREFIX: ${{ inputs.ENVPREFIX }}
          DOCKER_PUSH: ${{ inputs.DOCKER_PUSH }}

      - name: Set BRANCH ENVPREFIX is prod
        if: ${{ inputs.ENVPREFIX }} == 'prod'
        env:
          ENVPREFIX_BRANCH: main
        run: |
          echo "ENVPREFIX_BRANCH: $ENVPREFIX_BRANCH"

      - name: Set BRANCH ENVPREFIX is QA
        if: ${{ inputs.ENVPREFIX }} == 'QA'
        env:
          ENVPREFIX_BRANCH: release
        run: |
          echo "ENVPREFIX_BRANCH: $ENVPREFIX_BRANCH"
          
      - run: |
          echo "ENVPREFIX_BRANCH: $ENVPREFIX_BRANCH"
    
      - name: Check out repository code - helloworld
        uses: actions/checkout@v3

      - name: Check out repository code - smartparking-gitops
        uses: actions/checkout@v3
        with:
          repository: backend-sw-development-team4/smartparking-gitops
          path: smartparking-gitops
          ref: main
          token: ${{  secrets.PACKAGE_CONTAINER_AUTH }}

      - name: Check out repository code - service_name
        uses: actions/checkout@v3
        with:
          repository: backend-sw-development-team4/${{ inputs.SERVICE_NAME }}
          path: smartparking-gitops/${{ inputs.SERVICE_NAME }}
          ref: $ENVPREFIX_BRANCH
          token: ${{  secrets.PACKAGE_CONTAINER_AUTH }}

      - name: Check out repository code - gitops
        uses: actions/checkout@v3
        with:
          repository: backend-sw-development-team4/gitops
          path: smartparking-gitops/gitops
          ref: main
          token: ${{  secrets.PACKAGE_CONTAINER_AUTH }}

          